<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Thêm Truyện Mới</title>
    <link rel="stylesheet" href="../static/upload.css">
</head>
<body>
    <div>
        <h1>Thêm Thông Tin Truyện</h1>
        <h2>Chi Tiết Truyện</h2>
        <form id="addStoryForm">
            <div class="form-group">
                <label>Thêm trang bìa <span style="color: #888;"></span></label>
                <div class="image-upload">
                    <div class="image-placeholder" id="imagePreview"></div>
                    <input type="file" accept="image/*" id="imageInput" onchange="previewImage(event)">
                </div>
            </div>
            <div class="form-group">
                <label>Tiêu đề</label>
                <input type="text" placeholder="Tên truyện" required>
            </div>
            <div class="form-group">
                <label>Mô tả <span style="color: #888;"></span></label>
                <textarea placeholder="Mô tả nội dung truyện..." required></textarea>
            </div>
            <div class="form-group">
                <label>Thể loại <span style="color: #888;"></span></label>
                <div class="tag-group">
                    <label><input type="checkbox" name="tags" value="Ngôn tình"> Ngôn tình</label>
                    <label><input type="checkbox" name="tags" value="Huyền huyễn"> Huyền huyễn</label>
                    <label><input type="checkbox" name="tags" value="Khoa học viễn tưởng"> Khoa học viễn tưởng</label>
                    <label><input type="checkbox" name="tags" value="Kinh dị"> Kinh dị</label>
                </div>
            </div>
            <div class="buttons">
                <button type="button" class="cancel">Hủy</button>
                <button type="submit" class="submit">Xác nhận</button>
            </div>
        </form>
    </div>
    <script>
        const MAX_FILE_SIZE = 5 * 1024 * 1024; // 5MB
        const ALLOWED_TYPES = ['image/jpeg', 'image/png', 'image/gif'];

        function previewImage(event) {
            const file = event.target.files[0];
            if (!validateImage(file)) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const img = document.createElement('img');
                img.src = e.target.result;
                const imagePreview = document.getElementById('imagePreview');
                imagePreview.innerHTML = '';
                imagePreview.appendChild(img);
            };
            reader.readAsDataURL(file);
        }

        function validateImage(file) {
            if (!file) return false;
            
            if (!ALLOWED_TYPES.includes(file.type)) {
                alert('Chỉ chấp nhận file ảnh JPG, PNG hoặc GIF');
                return false;
            }
            
            if (file.size > MAX_FILE_SIZE) {
                alert('Kích thước file không được vượt quá 5MB');
                return false;
            }
            
            return true;
        }

        document.getElementById('addStoryForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const title = this.querySelector('input[type="text"]').value.trim();
            const description = this.querySelector('textarea').value.trim();
            const tags = Array.from(this.querySelectorAll('input[name="tags"]:checked')).map(tag => tag.value);
            const image = document.getElementById('imageInput').files[0];

            // Validate form
            if (title.length < 5) {
                alert('Tiêu đề phải có ít nhất 5 ký tự');
                return;
            }
            
            if (description.length < 20) {
                alert('Mô tả phải có ít nhất 20 ký tự');
                return;
            }
            
            if (tags.length === 0) {
                alert('Vui lòng chọn ít nhất một thể loại');
                return;
            }
            
            if (!image || !validateImage(image)) {
                alert('Vui lòng chọn ảnh bìa hợp lệ');
                return;
            }

            // Lưu dữ liệu vào localStorage và chuyển hướng
            const storyData = {
                title: title,
                description: description,
                tags: tags,
                image: image.name // Lưu tên file, vì nội dung file không thể lưu trực tiếp
            };
            localStorage.setItem('newStory', JSON.stringify(storyData));
            window.location.href = 'Write.html';
        });

        document.querySelector('.cancel').addEventListener('click', function() {
            if (confirm('Bạn có chắc muốn hủy không?')) {
                window.location.href = 'index.html';
            }
        });
    </script>
</body>
</html>