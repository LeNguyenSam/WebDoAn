<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Viết và Đăng Truyện</title>
    <link rel="stylesheet" href="../static/Write.css">
</head>
<body>
    <div class="container">
        <h1>Viết và Đăng Truyện</h1>
        <form id="chapterForm">
            <div class="form-group">
                <label>Tiêu đề chương</label>
                <input type="text" id="chapterTitle" placeholder="Tên chương">
                <div class="word-count">Số từ: <span id="wordCount">0</span></div>
            </div>

            <div class="form-group">
                <textarea id="chapterContent" placeholder="Viết ở đây..."></textarea>
            </div>

            <div class="preview-section" id="previewSection">
                <h2>Xem trước</h2>
                <div id="previewContent"></div>
            </div>

            <div class="buttons">
                <button type="button" class="submit" onclick="submitChapter()">Đăng tải</button>
                <button type="button" class="save" onclick="saveDraft()">Lưu</button>
                <button type="button" class="preview" onclick="togglePreview()">Xem trước</button>
            </div>
        </form>
    </div>
    <script>
        let autoSaveInterval;
        const AUTO_SAVE_DELAY = 30000; // 30 seconds

        function initializeEditor() {
            loadDraft();
            setupAutoSave();
            setupWordCount();
        }

        function setupAutoSave() {
            autoSaveInterval = setInterval(saveDraft, AUTO_SAVE_DELAY);
        }

        function setupWordCount() {
            const textarea = document.getElementById('chapterContent');
            textarea.addEventListener('input', updateWordCount);
        }

        function updateWordCount() {
            const content = document.getElementById('chapterContent').value;
            const wordCount = content.trim().split(/\s+/).length;
            document.getElementById('wordCount').textContent = wordCount;
        }

        function loadDraft() {
            const draft = localStorage.getItem('draft');
            if (draft) {
                const { title, content } = JSON.parse(draft);
                document.getElementById('chapterTitle').value = title || '';
                document.getElementById('chapterContent').value = content || '';
                updateWordCount();
            }
        }

        function togglePreview() {
            const previewSection = document.getElementById('previewSection');
            const content = document.getElementById('chapterContent').value;
            document.getElementById('previewContent').innerHTML = content;
            previewSection.style.display = previewSection.style.display === 'none' ? 'block' : 'none';
        }

        function submitChapter() {
            const title = document.querySelector('input[type="text"]').value.trim();
            const content = document.getElementById('chapterContent').value.trim();

            if (!title || !content) {
                alert('Vui lòng điền đầy đủ thông tin!');
                return;
            }

            // Lưu dữ liệu chương vào localStorage
            const storyId = localStorage.getItem('newStory') 
                ? JSON.parse(localStorage.getItem('newStory')).id 
                : Date.now(); // Sử dụng timestamp làm ID tạm thời nếu không có storyId
            const chapterData = {
                storyId,
                title,
                content,
                timestamp: new Date().toISOString()
            };
            const chapters = JSON.parse(localStorage.getItem('chapters') || '[]');
            chapters.push(chapterData);
            localStorage.setItem('chapters', JSON.stringify(chapters));

            // Xóa nháp sau khi đăng
            localStorage.removeItem('draft');

            // Chuyển hướng đến index.html
            window.location.href = 'index.html';
        }

        function saveDraft() {
            const title = document.querySelector('input[type="text"]').value;
            const content = document.getElementById('chapterContent').value;
            localStorage.setItem('draft', JSON.stringify({title, content}));
            alert('Đã lưu nháp!');
        }

        window.addEventListener('load', initializeEditor);
        window.addEventListener('beforeunload', (e) => {
            saveDraft();
            e.preventDefault();
            e.returnValue = '';
        });
    </script>
</body>
</html>